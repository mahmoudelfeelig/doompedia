name: doompedia-ios-signed-ipa

on:
  workflow_dispatch:
    inputs:
      export_method:
        description: "Xcode export method"
        type: choice
        required: true
        default: ad-hoc
        options:
          - development
          - ad-hoc
          - app-store

jobs:
  build-signed-ipa:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        working-directory: ios-app
        run: xcodegen generate

      - name: Import signing certificate and provisioning profile
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
          IOS_KEYCHAIN_PASSWORD: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          set -euo pipefail
          for secret_name in IOS_P12_BASE64 IOS_P12_PASSWORD IOS_PROVISIONING_PROFILE_BASE64 IOS_TEAM_ID; do
            if [ -z "${!secret_name:-}" ]; then
              echo "Missing required secret: $secret_name"
              exit 1
            fi
          done

          CERT_PATH="$RUNNER_TEMP/signing-cert.p12"
          PROFILE_PATH="$RUNNER_TEMP/profile.mobileprovision"
          PROFILE_PLIST="$RUNNER_TEMP/profile.plist"
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"

          printf '%s' "$IOS_P12_BASE64" | base64 -D > "$CERT_PATH"
          printf '%s' "$IOS_PROVISIONING_PROFILE_BASE64" | base64 -D > "$PROFILE_PATH"

          security create-keychain -p "$IOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$IOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$IOS_P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$IOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          security cms -D -i "$PROFILE_PATH" > "$PROFILE_PLIST"
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" "$PROFILE_PLIST")
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c "Print Name" "$PROFILE_PLIST")
          cp "$PROFILE_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/$PROFILE_UUID.mobileprovision"

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          echo "IOS_KEYCHAIN_PASSWORD=$IOS_KEYCHAIN_PASSWORD" >> "$GITHUB_ENV"
          echo "PROFILE_NAME=$PROFILE_NAME" >> "$GITHUB_ENV"

      - name: Archive signed iOS app
        working-directory: ios-app
        env:
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
          IOS_CODE_SIGN_IDENTITY: ${{ secrets.IOS_CODE_SIGN_IDENTITY }}
          IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
        run: |
          set -euo pipefail
          SIGN_IDENTITY="${IOS_CODE_SIGN_IDENTITY:-Apple Distribution}"
          BUNDLE_ID="${IOS_BUNDLE_ID:-com.feelbachelor.doompedia.ios}"

          xcodebuild \
            -project Doompedia.xcodeproj \
            -scheme Doompedia \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "$PWD/build/Doompedia.xcarchive" \
            DEVELOPMENT_TEAM="$IOS_TEAM_ID" \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="$SIGN_IDENTITY" \
            PROVISIONING_PROFILE_SPECIFIER="$PROFILE_NAME" \
            OTHER_CODE_SIGN_FLAGS="--keychain $KEYCHAIN_PATH" \
            archive

      - name: Export signed IPA
        working-directory: ios-app
        env:
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
          IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
        run: |
          set -euo pipefail
          BUNDLE_ID="${IOS_BUNDLE_ID:-com.feelbachelor.doompedia.ios}"

          cat > exportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
            <dict>
              <key>method</key>
              <string>${{ github.event.inputs.export_method }}</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>teamID</key>
              <string>${IOS_TEAM_ID}</string>
              <key>provisioningProfiles</key>
              <dict>
                <key>${BUNDLE_ID}</key>
                <string>${PROFILE_NAME}</string>
              </dict>
            </dict>
          </plist>
          EOF

          xcodebuild \
            -exportArchive \
            -archivePath "$PWD/build/Doompedia.xcarchive" \
            -exportPath "$PWD/build/export" \
            -exportOptionsPlist "$PWD/exportOptions.plist" \
            OTHER_CODE_SIGN_FLAGS="--keychain $KEYCHAIN_PATH"

      - name: Upload signed iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: doompedia-ios-signed
          path: |
            ios-app/build/export/*.ipa
            ios-app/build/export/DistributionSummary.plist

      - name: Cleanup keychain
        if: always()
        run: |
          set +e
          security delete-keychain "$KEYCHAIN_PATH"
